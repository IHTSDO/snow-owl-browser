<!DOCTYPE html>
<html>
	<head>
		<title>IHTSDO SNOMED CT Terminology Server Browser - beta</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width">
		<meta name="description" content="IHTSDO SNOMED CT Terminology Server Browser">
		<meta name="author" content="IHTSDO">

		<!-- External -->
		<script src="external-libs/jquery-2.1.0.min.js" type="text/javascript"></script>
		<script src="external-libs/jquery.splitter-0.14.0.js" type="text/javascript"></script>
		<script src="external-libs/bootstrap.min.js" type="text/javascript"></script>
		<script src="external-libs/handlebars-v1.3.0.js"></script>
		<script src="external-libs/jquery.i18n.properties-min-1.0.9.js"></script>
		<script src="external-libs/conduit.min.js" type="text/javascript"></script>
		<script src="external-libs/lodash.js" type="text/javascript"></script>
		<script src="external-libs/postal.min.js" type="text/javascript"></script>
		<script src="external-libs/jquery.svg.js" type="text/javascript"></script>
		<link rel="stylesheet" href="external-css/jquery.splitter.css">
		<link rel="stylesheet" href="external-css/bootstrap.min.css">

		<!-- Internal -->
		<link rel="stylesheet" href="css/flags.css">
		<link rel="stylesheet" href="css/jquery.splitter.css">
		<link rel="stylesheet" href="css/popover.css">
		<link rel="stylesheet" href="css/popover-extra-placements.css">
		<link rel="stylesheet" href="css/sct-diagram.css">
		<link rel="stylesheet" href="css/sct-widgets.css">

		<script>
			// Hack
			var globalMarkerColor = "black";
		</script>

		<script src="js/conceptDetailsPlugin.js"></script>
		<script src="js/countryIcons.js"></script>
		<script src="js/searchPlugin.js"></script>
		<script src="js/taxonomyPlugin.js"></script>
		<script src="js/refsetPlugin.js"></script>
		<script src="js/favoritesPlugin.js"></script>
		<script src="js/util.js"></script>
		<script src="js/authoringDecisionSupport.js"></script>
		<script src="js/drawConceptDiagram.js"></script>
		<script src="js/svgdiagrammingv2.js"></script>
		<script src="views/compiled/templates.js"></script>
		<script>
			this["JST"] = this["JST"] || {};
		</script>

		<script>
			function loadEmberTemplate(name) {
				var id = name;//.replace('/', '.');
				$.ajax({
					async: false,
					url: 'templates/' + name + '.html',
					dataType: 'text',
					success: function (html) {
						$('body').append($('<script>').attr('type', 'text/x-handlebars').attr('id', id).html(html));
					}
				});
			}

		</script>

		<script type="text/javascript">
			function initialize() {
				// Example: common options object
				var options = {
					serverUrl: "/snowowl/snomed-ct/v2/browser",
					release: "MAIN",
					selectedView: "inferred",
					displayChildren: false,
					langRefset: "900000000000509007",
					closeButton: false,
					collapseButton: false,
					linkerButton: true,
					subscribersMarker: true,
					searchMode: "partialMatching",
					searchLang: "english",
					diagrammingMarkupEnabled: false,
					highlightByEffectiveTime: "false"
				};
				var getUrlParameter = function getUrlParameter(sParam) {
					var sPageURL = decodeURIComponent(window.location.search.substring(1)),
						sURLVariables = sPageURL.split('&'),
						sParameterName,
						i;

					for (i = 0; i < sURLVariables.length; i++) {
						sParameterName = sURLVariables[i].split('=');

						if (sParameterName[0] === sParam) {
							return sParameterName[1] === undefined ? true : sParameterName[1];
						}
					}
				};
				var focusConcept = 138875005;
				if(getUrlParameter('branch'))
					{
						options.release = getUrlParameter('branch');
					}
				if(getUrlParameter('concept'))
				{
					focusConcept = getUrlParameter('concept');
				}
				
				var getProjectList = $.getJSON("/snowowl/snomed-ct/v2/branches/MAIN/children?immediateChildren=true").done(function(result) {
					var $projectDdl = $('#projectDdl');
					result.items.sort(function(a,b) {
					  if(a.name.split('-')[0] === b.name.split('-')[0])
					  {
						  a = a.name.split('-');
						  b = b.name.split('-');
						  if(a.length === 1)
						  {
							return -1   
						  }
						  else if(b.length === 1)
						  {
							return 1   
						  }
						  else{
							return parseInt(a[1]) - parseInt(b[1]);
						  }
					  }
					  else{
						  return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0);
					  }
					});
					$.each(result.items, function() {
						var relativePath = this.path.substring("MAIN/".length);
						$('<option>').val(this.path).text(this.name).appendTo($projectDdl);
					});
					$("#projectDdl").val(options.release).change();
					var projectChanged = function(){
						getTaskList();
						var branchPath = $('#projectDdl').val();
						options.release = branchPath;
						var tpt = new taxonomyPanel(document.getElementById("bp-taxonomy_canvas"), focusConcept, options);
						var searchP = new searchPanel(document.getElementById("bp-search_canvas"), options);
						var cdPanel = new conceptDetails(document.getElementById("bp-cd1_canvas"), focusConcept, options);

						cdPanel.subscribe(tpt);
						cdPanel.subscribe(searchP);
						cdPanel.setupCanvas();
					}
					$("#projectDdl").on("change", function(event) { 
						 projectChanged(this);
					});
				});
				
				var getTaskList = function () {
						$.getJSON("/snowowl/snomed-ct/v2/branches/" + $('#projectDdl').val() +"/children?immediateChild=true").done(function(result) {
						var $taskDdl = $('#taskDdl');
						$taskDdl.html("");
						$('<option>').val("None").text("None").appendTo($taskDdl);
						result.items.sort(function(a,b) {
						  if(a.name.split('-')[0] === b.name.split('-')[0])
						  {
							  a = a.name.split('-');
							  b = b.name.split('-');
							  if(a.length === 1)
							  {
								return -1   
							  }
							  else if(b.length === 1)
							  {
								return 1   
							  }
							  else{
								return parseInt(a[1]) - parseInt(b[1]);
							  }
						  }
						  else{
							  return (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0);
						  }
						});
						$.each(result.items, function() {
							var relativePath = this.path.substring("MAIN/".length);
							$('<option>').val(this.path).text(this.name).appendTo($taskDdl);
						});
						var taskChanged = function(){
							var branchPath = $('#taskDdl').val();
							//If no task selected in the task dropdown, use the project
							if (branchPath == "None") {
								branchPath = $('#projectDdl').val();
							}
							options.release = branchPath;
							var tpt = new taxonomyPanel(document.getElementById("bp-taxonomy_canvas"), focusConcept, options);
							var searchP = new searchPanel(document.getElementById("bp-search_canvas"), options);
							var cdPanel = new conceptDetails(document.getElementById("bp-cd1_canvas"), focusConcept, options);
	
							cdPanel.subscribe(tpt);
							cdPanel.subscribe(searchP);
							cdPanel.setupCanvas();
						}
						$("#taskDdl").on("change", function(event) { 
							 taskChanged(this);
						});
					});
				}
				
				var tpt = new taxonomyPanel(document.getElementById("bp-taxonomy_canvas"), focusConcept, options);
				var searchP = new searchPanel(document.getElementById("bp-search_canvas"), options);
				var cdPanel = new conceptDetails(document.getElementById("bp-cd1_canvas"), focusConcept, options);

				cdPanel.subscribe(tpt);
				cdPanel.subscribe(searchP);
				cdPanel.setupCanvas();
				$('#spliter2').split({orientation: 'vertical', limit: 20, position: '30%'});
			}
			$(document).ready(function() {
				initialize();
			});
		</script>

	</head>
	<body>
		<nav class="navbar navbar-default  navbar-static-top" role="navigation">
			<div>
				<div class="navbar-header">
				<a class="navbar-brand" href="javascript:void(0);" onclick="initialize();" id="navBarBrand"><strong>
						&nbsp;&nbsp;<span class="i18n" data-i18n-id="i18n_app_name">IHTSDO SNOMED Terminology Server Browser</span></strong></a>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1" style="padding-left: 20px; padding-right: 20px;">
					<span style="margin-left:10px">Project:</span>
					<select style="margin-top:18px; margin-left:2px;" id="projectDdl" on-change="projectChanged()">
							<option value="MAIN">MAIN</option>
					</select>
					<span style="margin-left:10px">Task:</span>
					<select style="margin-top:18px; margin-left:2px;" id="taskDdl" on-change="taskChanged()">
							<option value="None">None</option>
					</select>
					<ul class="nav navbar-nav navbar-right">
						<img class="pull-right visible-lg" src="img/newlogo.png" alt="IHTSDO delivering SNOMED, the global clinical terminology">
					</ul>
				</div>
			</div>
		</nav>
		<div id="browsing-perspective" class="container-fluid">
			<div id="spliter2" class="row" style="width:100%; height: 91%; position: absolute;">
				<div class="a panel panel-default" style="border-radius: 0px;">
					<ul class="nav nav-tabs" id="fh-tabs">
						<li class="active"><a href="#bp-taxonomy_canvas" data-toggle="tab"><span class="i18n" data-i18n-id="i18n_taxonomy">Taxonomy</span></a></li>
						<li><a href="#bp-search_canvas" data-toggle="tab"><span class="i18n" data-i18n-id="i18n_search">Search</span></a></li>
					</ul>
					<div class="tab-content">
						<div class="tab-pane active" id="bp-taxonomy_canvas" style="padding: 0px;margin: 0;"></div>
						<div class="tab-pane" id="bp-search_canvas" style="padding: 0px;margin: 0;"></div>
					</div>

				</div>
				<div class="col-md-6 panel panel-default" style="border-radius: 0px;" >
					<div class="col-md-12" id="bp-cd1_canvas" style="padding: 0px;margin: 0;"></div>
				</div>
			</div>
		</div>

	</body>
</html>